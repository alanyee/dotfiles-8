#!/usr/bin/env dash
# mpd
# planned: left click is toggle pause, right click is next, scroll is mpd volume.

maxWinNameLen=30

# target is picked based on which might be playing.
mpc | grep -q playing && mpcplaying=true || mpcplaying=false
mpvc | grep -q playing && mpvcplaying=true || mpvcplaying=false

if ! $mpvcplaying && ! $mpcplaying; then
  mpvc >/dev/null && target='mpvc' || target='mpc'
else
  $mpvcplaying && target='mpvc'
  $mpcplaying && target='mpc'
fi

$target | grep -q playing && playing=true || playing=false
$target | grep -q paused && paused=true || paused=false

if $playing || $paused; then
    title="$($target -f "%title%" | head -n 1)"
    # if title is empty, try file and trim from last / if exists.
    if [ -z "$title" ]; then
        if [ "$target" = "mpvc" ]; then
            title="$($target -f "%filename%" | head -n 1 | sed 's/.*\///;')"
        else
            title="$($target -f "%file%" | head -n 1 | sed 's/.*\///')"
        fi

        # peel some stuff
        title="$(echo "$title" | sed 's/【.*】//' | sed 's/\.[^.]*$//')"
    fi
else
  title="Stopped"
fi

# set $1 length to $maxWinNameLen chars (trim or pad)
setLength() {
    content="$1"

    count=$(echo -n "$content" | wc -m)
    remain=$(( $maxWinNameLen - $count ))

    extra=""
    if [ $(( $remain % 2 )) -ne 0 ]; then
        remain=$(( $remain - 1 ))
        extra=" "
    fi

    padding=""
    for i in $(seq $remain); do
        padding="$padding "
    done

    echo "$content$padding$extra";
}


maxWinNameLen=$(echo "$title" | cut -c 1-$maxWinNameLen | wc -m)
if [  "$title" = "Stopped" ]; then
    icon music
    echo Stopped
else
    printf "%s\n" "$title" | skroll -r -n $((maxWinNameLen-1)) -d 0 | head -n -1 | while IFS='\n' read -r out; do
        icon music
        $playing && icon pause
        $paused && icon play
        setLength "$out"
        sleep 0.2
    done
fi
